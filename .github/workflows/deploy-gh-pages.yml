name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - dev
    paths:
      - 'web/**'
      - 'Data/**'
      - '.github/workflows/deploy-gh-pages.yml'

  # 允許手動觸發
  workflow_dispatch:

# 設定 GITHUB_TOKEN 的權限
permissions:
  contents: write
  pages: write
  id-token: write

# 只允許一個部署任務同時執行
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 獲取所有歷史記錄以便獲取其他分支

      - name: Determine deployment path
        id: deployment
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "path=release" >> $GITHUB_OUTPUT
            echo "is_main=true" >> $GITHUB_OUTPUT
            echo "Deploying main branch to release/"
          elif [[ "${{ github.ref }}" == "refs/heads/dev" ]]; then
            echo "path=dev" >> $GITHUB_OUTPUT
            echo "is_main=false" >> $GITHUB_OUTPUT
            echo "Deploying dev branch to dev/"
          else
            echo "Unknown branch, skipping deployment"
            exit 1
          fi

      - name: Checkout gh-pages branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 嘗試檢出 gh-pages 分支，如果不存在則創建
          git fetch origin gh-pages || true
          if git rev-parse --verify origin/gh-pages > /dev/null 2>&1; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf .
            echo "# GitHub Pages" > README.md
            git add README.md
            git commit -m "Initialize gh-pages branch"
          fi

      - name: Update deployment files
        run: |
          # 清理舊的 deploy_temp（不應該被提交到 gh-pages）
          rm -rf deploy_temp
          
          # 刪除舊的目標目錄
          rm -rf ${{ steps.deployment.outputs.path }}

          # 使用 git checkout 從來源分支取得最新的 web/ 和 Data/
          git checkout ${{ github.sha }} -- web Data
          
          # 複製 web 目錄到目標路徑（排除 index.html）
          mkdir -p ${{ steps.deployment.outputs.path }}
          cd web
          find . -type f ! -name 'index.html' -exec cp --parents {} ../${{ steps.deployment.outputs.path }}/ \;
          cd ..
          
          # 複製 Data 目錄
          mkdir -p ${{ steps.deployment.outputs.path }}/Data
          cp -r Data/* ${{ steps.deployment.outputs.path }}/Data/

          # 如果是 main 分支部署，更新根目錄的 index.html 和 .nojekyll
          if [[ "${{ steps.deployment.outputs.is_main }}" == "true" ]]; then
            cp web/index.html .
            touch .nojekyll
          fi
          
          # 清理不需要的檔案
          rm -rf web Data

          # 添加所有更改
          git add -A

          # 顯示變更內容（用於調試）
          echo "=== Changes to be committed ==="
          git status --short
          
          # 檢查是否有更改
          if git diff --cached --quiet; then
            echo "No changes to deploy"
            exit 0
          fi
          
          # 提交並推送
          git commit -m "Deploy ${{ github.ref_name }} to ${{ steps.deployment.outputs.path }} - $(date +'%Y-%m-%d %H:%M:%S')"
          git push origin gh-pages
          echo "Deployment successful!"

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Path**: ${{ steps.deployment.outputs.path }}/" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ steps.deployment.outputs.path }}/" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
